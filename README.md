# Управление на резервации за ресторанти

Уеб приложение на **Flask** за управление на резервации в ресторанти.  
Поддържа няколко роли (обикновен потребител, собственик на заведение, администратор) и многостъпков процес за резервация по дата, час, зона и маса.

---

## 1. Основни функционалности

### Публична част

- Начална страница с лого и бутон **Book** (`/`)
- Регистрация на нов потребител (`/registration`)
- Вход в системата по потребителско име или e-mail (`/login`)

### Роли и права

В модела `UserRole` има три роли:

- `user` – обикновен потребител (клиент)
- `provider` – собственик на заведение
- `admin` – администратор на системата

Ролите се настройват от администратора в админ панела.

### Функционалности за **клиент** (`user`)

- Преглед на списък с ресторанти (`/restaurants`)
- Детайли за ресторант – адрес, категория, работно време, описание и снимка (`/restaurants/<id>/details`)
- Многостъпков процес за резервация:
  1. избор на дата от календар
  2. избор на брой хора
  3. избор на час спрямо работното време на ресторанта и заетостта на масите
  4. избор на зона и маса
- Преглед на собствените резервации (`/my_reservations`):
  - таблица с ресторант, дата, час, маса и статус
  - възможност за **отказване** на резервация (ако статусът го позволява)
  - възможност за **редакция** на резервация (връща към wizard-а със запълнени стойности)

### Функционалности за **собственик** (`provider`)

- Страница **My Restaurants** (`/my_restaurants`) – списък с ресторанти, които принадлежат на логнатия provider
- Възможност за:
  - създаване на нов ресторант (многостъпков процес)
  - редакция на съществуващ ресторант
  - настройване на зони и маси за ресторанта
- Страница **Reservations** (`/provider_reservations`) – всички резервации към ресторантите на provider-а:
  - смяна на статус на резервацията (pending/accepted/canceled/completed)
  - отваряне на резервация в режим за редакция (същият wizard като за клиента)

### Функционалности за **администратор** (`admin`)

- Страница **Users** (`/users`):
  - списък с потребители
  - промяна на роля (user / provider / admin)
  - изтриване на потребител
- Страница **All reservations** (`/reservations`):
  - преглед на всички резервации в системата в унифицирана таблица
  - промяна на статус (същата таблица и поведение като при provider-а)

### Модел на данните (основни таблици)

Файл: `models/reservation.py`

- `Restaurant` – име, адрес, категория, описание, работно време, поле `image_url` за снимка
- `Zone` – зона в ресторанта (например “Garden”, “Inside”)
- `Table` – маса в дадена зона с капацитет
- `Reservation` – резервация с:
  - клиент (`client_id`)
  - ресторант, маса и зона
  - дата/час
  - статус (`ReservationStatus`: pending, accepted, canceled, completed)
- `Review` – модел за ревюта (потребител, ресторант, оценка 1–5, коментар)

Файл: `models/user.py`

- `User` – име, e-mail, хеширана парола, роля и връзки към резервации/ресторанти/ревюта.

---

## 2. Технологии

- **Python 3.11+**
- **Flask** – уеб фреймуърк
- **SQLAlchemy** – ORM слой
- **PostgreSQL** – база данни (по подразбиране)
- **psycopg2** – PostgreSQL драйвър
- **bcrypt** – хеширане на пароли
- **python-dotenv** – зареждане на настройки от `.env`
- HTML шаблони с **Jinja2** и един общ layout
- Статичен CSS дизайн в `static/style.css`

---

## 3. Структура на проекта

```text
PythonProject/
├── main.py                # Flask приложение, регистрация на blueprint-и
├── db.py                  # SQLAlchemy engine и SessionLocal
├── db_setup.py            # създаване на таблиците
├── seed_admin.py          # автоматично създаване на администратор
├── .env                   # секретен ключ и данни за admin акаунта
├── models/
│   ├── __init__.py
│   ├── user.py            # User и UserRole
│   └── reservation.py     # Restaurant, Zone, Table, Reservation, Review, ReservationStatus
├── routers/               # отделни модули за различните части
│   ├── auth.py            # регистрация и логин
│   ├── admin.py           # админ панел – потребители и резервации
│   ├── provider.py        # страници за собственици на ресторанти
│   ├── restaurants.py     # списък и детайли за ресторанти
│   ├── reservation.py     # wizard за резервации (дата/час/зона/маса)
│   ├── create_restaurant.py  # wizard за създаване/редакция на ресторант
│   └── profile.py         # профил / “My reservations” за клиента
├── templates/
│   ├── layouts/layout.html      # общ layout и top навигация
│   ├── home.html
│   ├── auth/...
│   ├── admin/...
│   ├── provider/...
│   ├── profile/my_reservations.html
│   ├── restaurants/...
│   ├── reservation/...
│   └── partials/
│       ├── restaurant_list.html
│       └── reservations_table.html
└── static/
    ├── style.css
    └── images/
        ├── logo.png
        └── burattaItaliana.jpg
```

---

## 4. Настройки и подготовка

### 4.1. База данни

Проектът очаква PostgreSQL база, конфигурирана в `db.py`:

```python
engine = create_engine(
    'postgresql+psycopg2://postgres:password@localhost:5432/reservations_db'
)
```

Преди да стартирате приложението:

1. Създайте база данни:

```sql
CREATE DATABASE reservations_db;
```

2. При нужда коригирайте потребител, парола, хост и име на база в `db.py`.

### 4.2. Виртуална среда и зависимости

Препоръчително е да използвате собствена виртуална среда, а не включената `.venv`.

```bash
python -m venv .venv
# Windows:
.venv\Scripts\activate
# Linux / macOS:
source .venv/bin/activate
```

Инсталирайте нужните пакети (минимално):

```bash
pip install flask sqlalchemy psycopg2-binary python-dotenv bcrypt
```

По желание може да си генерирате `requirements.txt`:

```bash
pip freeze > requirements.txt
```


### 4.3. Създаване на таблиците

След като базата е създадена и настройките са коректни, изпълнете:

```bash
python db_setup.py
```

Това ще създаде всички таблици, описани в моделите.

---

## 5. Стартиране на приложението

От директория `PythonProject/`:

```bash
python main.py
```

По подразбиране приложението стартира на:

- http://127.0.0.1:5000/

Първото стартиране извиква `create_admin_if_not_exist()` от `seed_admin.py`, което:

- проверява дали има поне един потребител с роля `admin`
- ако няма, създава администратор, използвайки `ADMIN_USERNAME`, `ADMIN_EMAIL` и `ADMIN_PASSWORD` от `.env`

Вход като администратор:

- username: стойността от `ADMIN_USERNAME`
- password: стойността от `ADMIN_PASSWORD`

---

## 6. Навигация и основни страници

### Главно меню (`layouts/layout.html`)

В горната навигация се показват различни линкове според това дали има логнат потребител и каква е ролята му:

- Без вход:
  - Home
  - Registration
  - Login
- Логнат потребител (`user`):
  - Home
  - Restaurants
  - My reservations
  - Logout
- Логнат `provider`:
  - Home
  - Restaurants
  - My Restaurants
  - Reservations (за ресторантите на този provider)
  - My reservations като клиент, ако има такива
  - Logout
- Логнат `admin`:
  - Home
  - Restaurants
  - Users
  - All Reservations
  - My reservations, ако админът има собствени резервации
  - Logout

---

## 7. Резервации – логика

- Календарът за избор на дата показва:
  - заетост на ресторанта по дни
  - блокира минали дати
- При избиране на ден:
  - показват се свободни часови слотове между `open_time` и `close_time` на ресторанта
  - за всеки час се проверява наличността на маси (спрямо броя хора)
- Статус на резервация:
  - начално обикновено е `pending`
  - provider/admin могат да го променят на `accepted`, `canceled`
- Помощна функция `auto_complete_old_reservations`:
  - за стари резервации със статус `accepted` автоматично сменя на `completed`, за да не стоят вечно активни

---


## 8. Обобщение

Този проект демонстрира:

- работа с Flask, blueprint-и и Jinja2 шаблони
- ORM модели със SQLAlchemy и релации между тях
- многостъпкови форми и използване на `session` за запомняне на междинни данни
- базова админ част за управление на потребители и резервации
- практики като:
  - хеширане на пароли с bcrypt
  - зареждане на конфигурация от `.env`
  - разделяне на логиката по модули (routers, models, templates)